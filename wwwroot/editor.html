<!DOCTYPE html>
<html>
    <head>
        <title>Editor</title>
        
        <meta charset="UTF-8">
        
        <base href="/">
        
        <style>
            
            @font-face {
                font-family: rubik;
                src: url(static/res/rubik.ttf);
            }
            
            @font-face {
                font-family: dejavu;
                src: url(static/res/dejavu.ttf);
            }
            
            ::-webkit-scrollbar {
                width: 7px;
                height: 7px;
            }
            
            ::-webkit-scrollbar-track {
                background: #222;
            }
            
            ::-webkit-scrollbar-thumb {
                background: #444;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            ::-webkit-scrollbar-corner {
                background: none;
            }
            
            :root {
                --bar-height: 3rem;
            }
            
            html, body {
                height: 100vh;
            }
            
            body, button {
                font-family: rubik;
                font-size: 1em;
                color: white;
            }
            
            body {
                background-color: #111;
                line-height: 1.25;
                display: flex;
                flex-direction: column;
            }
            
            body, main, .editor, .output {
                margin: 0;
            }
            
            main {
                flex: 1;
                display: flex;
            }
            
            .editor, .editor * {
                font-family: dejavu !important;
            }
            
            .editor {
                flex: 3;
                font-size: .9em !important;
                line-height: 1.6em !important;
            }
            
            .output {
                flex: 1;
                overflow: hidden scroll;
                height: calc(100vh - var(--bar-height) * 2);
                transition: .15s;
            }
            
            .output pre {
                background-color: #111;
                font-family: dejavu;
                line-height: 1.25;
                font-size: .85em;
                margin: 0;
                padding: 1em;
                box-sizing: border-box;
            }
            
            .output iframe {
                border: none;
                background-color: white;
                width: 100%;
                height: 100%;
                margin: 0;
            }
            
            .output:has(iframe:not(.hidden)) {
                overflow-y: hidden;
            }
            
            .output iframe:not(.hidden) {
                display: block;
            }
            
            .expand-button {
                display: none;
                background: #754 url(icon/fullscreen.svg) no-repeat center;
                background-size: contain;
                width: 1.75em;
                aspect-ratio: 1;
                position: absolute;
                cursor: pointer;
                border-radius: 0 0 .25em 0;
                filter: opacity(.8) brightness(.9);
            }
            
            .expand-button:hover {
                filter: opacity(1) brightness(.9);
            }
            
            .expand-button:active {
                filter: opacity(1) brightness(1);
            }
            
            .output:hover .expand-button {
                display: block;
            }
            
            .output.expanded {
                flex: 10;
            }
            
            .output.expanded .expand-button {
                background-image: url(icon/fullscreenexit.svg);
            }
            
            .bar {
                display: flex;
                justify-content: center;
                gap: 1em;
                box-shadow: 0 0 1.5em 0 #0006;
                z-index: 10;
                height: var(--bar-height);
                padding: .5em 1em;
                box-sizing: border-box;
                background: linear-gradient(#333, #222);
            }
            
            .bar > div {
                color: #f90;
                margin: auto;
            }
            
            button {
                border: none;
                outline: none;
                cursor: pointer;
                border-radius: .125em;
                filter: brightness(.8);
                display: flex;
                align-items: stretch;
                margin: 0;
                padding: 0;
                background: none;
                border-radius: .125em;
                overflow: hidden;
                box-shadow: 0 0 .5em 0 #0002;
            }
            
            button:hover {
                filter: brightness(.9);
            }
            
            button:active {
                filter: brightness(1);
            }
            
            body.disabled button,
            button.disabled {
                filter: saturate(0) brightness(.6);
                pointer-events: none;
            }
            
            button > div {
                padding: 0 .675em;
                display: flex;
                align-items: center;
            }
            
            button > div:first-child {
                background: linear-gradient(#666, #444);
            }
            
            button > div:last-child {
                background: linear-gradient(#2229, #1119);
                font-size: .8em;
            }
            
            .hidden {
                display: none;
            }
            
        </style>
        
        <script src="static/ace/ace.js"></script>
        
        <script>
            
            const outputType = `<!--output-type-->`
            
            const aceInstances = { }
            
            function loadACE(elementId)
            {
                const editor = ace.edit(elementId);
                
                editor.setTheme("ace/theme/merbivore_soft");
                
                editor.session.setMode("ace/mode/csharp");
                
                editor.commands.bindKeys({
                    f1: null,
                    f2: null
                })
                
                const r = editor.renderer
                
                r.setAnimatedScroll(true)
                r.setVScrollBarAlwaysVisible(true)
                r.setOption("showPrintMargin", true)
                r.setPadding(15)
                r.setScrollMargin(10)
                r.setOption("scrollPastEnd", 0.5)
                
                aceInstances[elementId] = editor;
            }
            
            function getACEValue(elementId)
            {
                return aceInstances[elementId].getValue();
            }
            
            function setACEValue(elementId, value)
            {
                aceInstances[elementId].setValue(value, -1);
            }
            
            function htmlEntities(str)
            {
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
            }
            
            addEventListener(`load`, () =>
            {
                loadACE(`editor`)
                
                setACEValue(`editor`, atob(`<!--script-->`))
                
                const $output = document.querySelector(`.output`)
                const $iframe = $output.querySelector(`iframe`)
                const $pre = $output.querySelector(`pre`)
                const $run = document.querySelector(`#run`)
                
                document.querySelector(`#save`).addEventListener(`click`, async () =>
                {
                    document.body.classList.add(`disabled`)
                    
                    const data = {
                        identifier: { id: parseInt("<!--id-->") },
                        script: getACEValue(`editor`)
                    }
                    
                    await fetch(`api/reverseproxyroutes/script`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })
                    
                    document.body.classList.remove(`disabled`)
                })
                
                document.querySelector(`#close`).addEventListener(`click`, () => close())
                
                $run.addEventListener(`click`, async () =>
                {
                    document.body.classList.add(`disabled`)
                    
                    const response = await fetch(`api/run`,
                    {
                        method: `post`,
                        headers: { "Content-Type": `text/plain` },
                        body: getACEValue(`editor`)
                    })
                    
                    const content = await response.text()
                    
                    if (content != `` && outputType == `Html`)
                    {
                        $pre.classList.add(`hidden`)
                        $iframe.classList.remove(`hidden`)
                        $iframe.src = URL.createObjectURL(
                            new Blob([ content ], { type: `text/html` })
                        )
                    }
                    else
                    {
                        $iframe.classList.add(`hidden`)
                        $pre.classList.remove(`hidden`)
                        $pre.innerHTML = htmlEntities(content)
                    }
                    
                    document.body.classList.remove(`disabled`)
                })
                
                document.querySelector(`#clear`).addEventListener(`click`, async () =>
                {
                    $iframe.src = ``
                    $iframe.classList.add(`hidden`)
                    $pre.innerHTML = ``
                    $pre.classList.remove(`hidden`)
                })
                
                document.querySelector(`.expand-button`).addEventListener(`click`, () =>
                {
                    $output.classList.toggle(`expanded`)
                })
                
                addEventListener(`keydown`, e =>
                {
                    if (e.key == `F5`)
                    {
                        e.preventDefault()
                        if (e.ctrlKey)
                            setTimeout(() => location.reload(), 10)
                        else
                            document.querySelector(`#run`).click()
                        return
                    }
                    
                    if (e.key == `Escape`)
                    {
                        e.preventDefault()
                        document.querySelector(`#clear`).click()
                        return
                    }
                    
                    if (e.ctrlKey && e.key == `s`)
                    {
                        e.preventDefault()
                        document.querySelector(`#save`).click()
                        return
                    }
                })
                
                $run.click()
            })
            
        </script>
    </head>
    <body>
        <div class="bar">
            <div><!--title--></div>
            <div style="flex: 1; "></div>
            <button id="run"><div>Run</div><div>F5</div></button>
            <div style="flex: 1; "></div>
            <button id="clear"><div>Clear</div><div>Esc</div></button>
        </div>
        <main>
            <pre class="editor" id="editor"></pre>
            <div class="output" id="output">
                <div class="expand-button"></div>
                <pre></pre>
                <iframe class="hidden"></iframe>
            </div>
        </main>
        <div class="bar">
            <button id="save"><div>Save</div><div>Ctrl+S</div></button>
            <button id="close"><div>Close</div><div>Ctrl+W</div></button>
        </div>
    </body>
</html>