<h2><i class="fas fa-paperclip"></i>Share</h2>
<div id="form">
    <label id="dropzone" for="file">Drop files here or click to open dialog</label>
    <div class="file-list"></div>
    <button id="clear"><i class="fas fa-trash"></i>Clear</button>
    <textarea id="text" type="text" placeholder="Title / Description / Notes"></textarea>
    <input id="password" type="password" placeholder="Password">
</div>
<button id="submit"><i class="fas fa-paper-plane"></i>Submit</button>
<style>
    h2 {
        font-size: 2em;
    }
    h2 > i {
        color: #f90;
        margin-right: .375em;
    }
    #form {
        width: 25em;
        display: flex;
        flex-direction: column;
        max-width: 70vw;
        flex: 0;
        gap: 1rem;
        margin: 1rem 0;
    }
    #text {
        height: 7.75em;
    }
    #dropzone {
        background: #0003;
        border: 2px dashed #fff3;
        padding: 1.25rem;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: .75rem;
        text-align: center;
        display: block;
        line-height: 1.5;
    }
    #dropzone:not(.disabled) {
        cursor: pointer;
    }
    #dropzone:not(.disabled):hover {
        filter: brightness(1.4);
    }
    #dropzone.disabled {
        cursor: default;
        filter: brightness(0.6);
    }
    #dropzone,
    #dropzone > div {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    #dropzone > div {
        width: 100%;
    }
    .file-list {
        max-height: calc(100vh - 50.75rem);
    }
    #clear {
        background-color: #632;
        align-self: center;
    }
    input[type="file"] {
        display: none;
    }
</style>
<script>
    addEventListener(`load`, () =>
    {
        register(['dragover', 'dragenter'], e => e.preventDefault())
        
        register(['drop'], e =>
        {
            e.preventDefault()
            if (q(`#file`).disabled)
                return
            addFiles(e.dataTransfer.files)
        })
        
        q(`#password`).addEventListener(`keydown`, e =>
        {
            if (e.keyCode == 13)
            {
                e.preventDefault = true
                q(`#submit`).click()
            }
        })
        
        q(`#submit`).addEventListener(`click`, async e =>
        {
            setEnabled(false)
            if (await submitAsync())
                return
            setEnabled(true)
        })
        
        q(`#clear`).addEventListener(`click`, () => clearFiles())
        
        clearFiles()
        addFiles()
    })
    
    function setEnabled(enabled)
    {
        q(`#text`).disabled = !enabled
        q(`#dropzone`).setClass(`disabled`, !enabled)
        q(`#file`).disabled = !enabled
        q(`#password`).disabled = !enabled
        q(`#submit`).disabled = !enabled
        q(`#clear`).disabled = !enabled
    }
    
    function addFiles(files)
    {
        if (window.$file)
        {
            $file.id = ``
            $file.files = files
        }
        $file = $body.create(`input`)
        $file.id = `file`
        $file.type = `file`
        $file.setAttribute(`multiple`, ``)
        $file.addEventListener('change', () => addFiles())
        updateFileList()
    }
    
    function clearFiles()
    {
        qAll(`input[type="file"]`).forEach($ =>
        {
            if (!$.id)
                $.remove()
        })
        updateFileList()
    }
    
    function iterateFiles()
    {
        const files = []
        qAll(`input[type="file"]`).forEach($ =>
        {
            for (const file of $.files)
                files.push(file)
        })
        return files
    }
    
    function updateFileList()
    {
        let html = ``
        qAll(`input[type="file"]`).forEach($ =>
        {
            for (const file of $.files)
            {
                const fileName = file.name
                const fileExtension = fileName.split('.').pop()
                const iconUrl = `icon?file-extension=${fileExtension}`
                html += `
                    <div>
                        <div>
                            <div style="background: url(${iconUrl})"></div>
                            <div>${fileName}</div>
                        </div>
                    </div>
                `
            }
        })
        q(`.file-list`).innerHTML = html
        
        const display = html ? `` : `none`
        q(`.file-list`).style.display = display
        q(`#clear`).style.display = display
    }
    
    function register(a, b)
    {
        for (const _a of a)
            document.body.addEventListener(_a, b)
    }
    
    async function submitAsync()
    {
        const password = btoa(q(`#password`).value)
        
        const formData = new FormData()
        formData.append('text', q(`#text`).value)
        formData.append('password', password)
        
        qAll(`input[type="file"]`).forEach($ =>
        {
            for (const file of $.files)
                formData.append('files[]', file)
        })
        
        const response = await fetch(`share`,
        {
            method: "POST",
            body: formData
        })
        
        if (response.ok)
        {
            const token = await response.text()
            location.href = `share/${token}$${password}`
            return true
        }
        
        return false
    }
</script>